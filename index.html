<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>コーヒー嗜好診断（フル版）</title>
  <style>
    :root { --ink:#111; --muted:#666; --line:#e6e6e6; }
    *{ box-sizing:border-box; }
    body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif; margin:0; padding:24px; color:var(--ink); background:#fff; }
    h1{ font-size:20px; margin:0 0 8px; }
    .lead{ color:var(--muted); margin:0 0 18px; }
    .card{ border:1px solid var(--line); border-radius:12px; padding:16px; margin:12px 0; }
    .section-title{ font-weight:700; margin:0 0 8px; }
    .row{ display:grid; grid-template-columns:1fr; gap:12px; }
    @media (min-width:760px){ .row{ grid-template-columns:1fr 1fr; } }
    label{ display:block; }
    .slider{ width:100%; }
    .v{ display:inline-block; min-width:28px; text-align:right; color:var(--muted); font-variant-numeric:tabular-nums; }
    .actions{ display:flex; gap:12px; margin-top:12px; }
    button{ appearance:none; border-radius:10px; padding:10px 14px; cursor:pointer; }
    .primary{ background:#111; color:#fff; border:1px solid #111; }
    .secondary{ background:#fff; color:#111; border:1px solid #111; }
    .hidden{ display:none; }
    .result h2{ margin:12px 0 8px; font-size:18px; }
    .rank{ padding-left:20px; }
    .rank li{ margin:6px 0; }
    .bar-wrap{ background:#f0f0f0; height:10px; border-radius:6px; overflow:hidden; margin:6px 0 10px; }
    .bar{ height:10px; background:#111; border-radius:6px; }
    .qr{ margin-top:16px; }
    .refs{ font-size:12px; color:#444; line-height:1.6; margin-top:16px; }
    .foot{ color:#777; font-size:12px; margin-top:12px; }
  </style>
</head>
<body>
  <main id="app">
    <h1>コーヒー嗜好診断</h1>
    <p class="lead">16問に答えると、6産地（A〜F）からあなたに合うコーヒーをランキング表示します。結果画面には<strong>あなたの回答に強く寄与した設問に紐づく論文</strong>（タイトル＋抜粋）も表示されます。</p>

    <!-- 質問フォーム（Q0 + Q1〜Q16 = 17項目） -->
    <form id="form" autocomplete="off">
      <div class="card">
        <div class="section-title">履歴バイアス（補正）</div>
        <label>Q0. コーヒーを飲み始めた年
          <select id="startYear">
            <option value="2021+">2021年以降</option>
            <option value="2016-2020">2016〜2020年</option>
            <option value="<=2015">2015年以前</option>
          </select>
        </label>
      </div>

      <div class="card">
        <div class="section-title">嫌い嗜好（遺伝・忌避）※0=全く気にならない / 9=非常に嫌い</div>
        <div class="row">
          <label>Q1. コリアンダー（パクチー）の香りが嫌い <span class="v" id="v_q1">0</span>
            <input class="slider" type="range" min="0" max="9" value="0" id="q1">
          </label>
          <label>Q2. キニーネのような強い苦味が嫌い <span class="v" id="v_q2">0</span>
            <input class="slider" type="range" min="0" max="9" value="0" id="q2">
          </label>
          <label>Q3. ステビア様の甘味・後味が嫌い <span class="v" id="v_q3">0</span>
            <input class="slider" type="range" min="0" max="9" value="0" id="q3">
          </label>
          <label>Q4. 濡れた土／土埃のような香りが嫌い <span class="v" id="v_q4">0</span>
            <input class="slider" type="range" min="0" max="9" value="0" id="q4">
          </label>
          <label>Q5. うま味（昆布・椎茸様）が強いのは嫌い <span class="v" id="v_q5">0</span>
            <input class="slider" type="range" min="0" max="9" value="0" id="q5">
          </label>
        </div>
      </div>

      <div class="card">
        <div class="section-title">香り・風味の好み（0=全く好みでない / 9=非常に好き）</div>
        <div class="row">
          <label>Q6. 花の香り（フローラル）が好き <span class="v" id="v_q6">0</span>
            <input class="slider" type="range" min="0" max="9" value="0" id="q6">
          </label>
          <label>Q7. 焼き菓子／キャラメルが好き <span class="v" id="v_q7">0</span>
            <input class="slider" type="range" min="0" max="9" value="0" id="q7">
          </label>
          <label>Q8. ナッツ／ココア／トーストが好き <span class="v" id="v_q8">0</span>
            <input class="slider" type="range" min="0" max="9" value="0" id="q8">
          </label>
          <label>Q9. スパイス／燻製が好き <span class="v" id="v_q9">0</span>
            <input class="slider" type="range" min="0" max="9" value="0" id="q9">
          </label>
          <label>Q10. カラメル／アーモンドが好き <span class="v" id="v_q10">0</span>
            <input class="slider" type="range" min="0" max="9" value="0" id="q10">
          </label>
          <label>Q11. 甘酸っぱい果物（ベリー／トロピカル）が好き <span class="v" id="v_q11">0</span>
            <input class="slider" type="range" min="0" max="9" value="0" id="q11">
          </label>
          <label>Q12. 余韻が長いのが好き <span class="v" id="v_q12">0</span>
            <input class="slider" type="range" min="0" max="9" value="0" id="q12">
          </label>
          <label>Q13. 口あたり（オイリー／ジューシー感）が好き <span class="v" id="v_q13">0</span>
            <input class="slider" type="range" min="0" max="9" value="0" id="q13">
          </label>
        </div>
      </div>

      <div class="card">
        <div class="section-title">性格・行動傾向（0=当てはまらない / 9=非常に当てはまる）</div>
        <div class="row">
          <label>Q14. ホラー映画が好き（刺激志向） <span class="v" id="v_q14">0</span>
            <input class="slider" type="range" min="0" max="9" value="0" id="q14">
          </label>
          <label>Q15. 新しいものが好き（冒険的） <span class="v" id="v_q15">0</span>
            <input class="slider" type="range" min="0" max="9" value="0" id="q15">
          </label>
          <label>Q16. 発酵系フレーバー（ワイン／チーズ等）が好き <span class="v" id="v_q16">0</span>
            <input class="slider" type="range" min="0" max="9" value="0" id="q16">
          </label>
        </div>
      </div>

      <div class="actions">
        <button type="button" id="submit" class="primary">診断する</button>
        <button type="reset" id="resetBtn" class="secondary">リセット</button>
      </div>
    </form>

    <!-- 結果表示 -->
    <section id="results" class="result hidden">
      <h2>あなたに合うコーヒー（ランキング 1〜6位）</h2>
      <ol id="rank" class="rank"></ol>
      <div id="bars"></div>
      <div class="qr" id="qrcode"></div>

      <!-- 論拠（回答寄与に応じて動的に表示） -->
      <div class="refs" id="refs">
        <strong>参考（あなたの回答で影響が大きかった設問に紐づく論拠）</strong>
        <ul id="refList" style="padding-left:1.2rem;margin:6px 0 0;"></ul>
      </div>

      <div class="actions">
        <button type="button" id="back" class="secondary">設問にもどる</button>
      </div>
      <div class="foot">※ 診断は研究知見に基づくモデル化であり、焙煎度・品種・処理方法等により変動します。</div>
    </section>
  </main>

  <!-- QRコード生成 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    // スライダーの値表示
    for (let i=1;i<=16;i++){
      const el = document.getElementById('q'+i);
      const v  = document.getElementById('v_q'+i);
      el.addEventListener('input', ()=> v.textContent = el.value);
    }

    /* ===== スコアモデル ===== */
    const AX = ["CITRUS","FLORAL","NUTTY","CARAMEL","SPICY","ROAST","BITTER","UMAMI","FRUITY","AFTERTASTE"];

    // 産地の香味ベクトル（相対/正規化前）
    const ORIGIN = {
      A: [0.9, 1.0, 0.1, 0.2, 0.2, 0.2, 0.1, 0.1, 0.9, 0.6], // Ethiopia
      B: [0.4, 0.5, 0.3, 0.4, 0.2, 0.4, 0.3, 0.3, 0.5, 0.6], // Colombia
      C: [0.1, 0.2, 0.9, 0.8, 0.1, 0.8, 0.4, 1.0, 0.3, 0.5], // Brazil
      D: [1.0, 0.6, 0.1, 0.2, 0.2, 0.3, 0.5, 0.3, 0.8, 0.8], // Kenya
      E: [0.1, 0.2, 0.3, 0.3, 0.9, 0.9, 0.6, 0.9, 0.2, 0.5], // Indonesia
      F: [0.4, 0.7, 0.2, 0.2, 0.2, 0.3, 0.2, 0.3, 0.6, 0.6], // Burundi
    };

    const norm = arr => { const s = Math.hypot(...arr); return s ? arr.map(x => x/s) : arr.slice(); };

    function userAxis(){
      const g = id => Number(document.getElementById(id).value);
      // ユーザー嗜好（0..9 -> 0..1）
      const like = {
        FLORAL: g('q6')/9,
        CARAMEL: (g('q7')+g('q10'))/18,
        NUTTY: g('q8')/9,
        SPICY: g('q9')/9,
        FRUITY: g('q11')/9,
        CITRUS: g('q11')/18 + 0.05*g('q6'),
        ROAST: (g('q7')+g('q8')+0.5*g('q9'))/27,
        AFTERTASTE: g('q12')/9,
        UMAMI: (0.4*g('q7')+0.3*g('q8')+0.3*g('q13'))/9,
        BITTER: g('q14')/9 // ホラー嗜好 = 苦味耐性の代理
      };
      return [like.CITRUS, like.FLORAL, like.NUTTY, like.CARAMEL, like.SPICY, like.ROAST, like.BITTER, like.UMAMI, like.FRUITY, like.AFTERTASTE];
    }

    function baseScores(){
      const u = norm(userAxis());
      const s = {A:0,B:0,C:0,D:0,E:0,F:0};
      for (const k of Object.keys(ORIGIN)){
        const v = norm(ORIGIN[k]);
        s[k] = u.reduce((acc,x,i)=> acc + x*v[i], 0) * 100; // 0..100
      }
      return s;
    }

    function applyAdjustments(scores){
      const g = id => Number(document.getElementById(id).value);

      // 嫌い嗜好の減点（寄与強）
      const cor = g('q1'); // コリアンダー嫌悪 → A,D,F 減
      scores.A -= 1.2*cor; scores.D -= 1.2*cor; scores.F -= 0.8*cor;

      const quin = g('q2'); // キニーネ嫌悪 → D,E,B 減
      scores.D -= 1.0*quin; scores.E -= 1.0*quin; scores.B -= 0.8*quin;

      const ste = g('q3'); // ステビア嫌悪 → B,E 減
      scores.B -= 0.8*ste; scores.E -= 0.8*ste;

      const earth = g('q4'); // 土嫌悪 → E 強, C 弱 減
      scores.E -= 1.2*earth; scores.C -= 0.6*earth;

      const uma = g('q5'); // うま味嫌悪 → C 強, E 中, F 弱 減
      scores.C -= 1.2*uma; scores.E -= 1.0*uma; scores.F -= 0.6*uma;

      // 性格・嗜好ベースの微調整
      const horror = g('q14'); // 苦味耐性 proxy → D,C,E 微加点
      scores.D += 0.6*horror; scores.C += 0.4*horror; scores.E += 0.4*horror;

      const novel = g('q15'); // 新しいもの好き → A,B 加点
      scores.A += 0.7*novel; scores.B += 0.6*novel;

      const ferm = g('q16'); // 発酵好き → B 強, A/E 軽
      scores.B += 0.8*ferm; scores.A += 0.4*ferm; scores.E += 0.3*ferm;

      // 履歴バイアス（2015年以前）
      const start = document.getElementById('startYear').value;
      if (start === '<=2015'){ scores.C *= 1.08; scores.D *= 1.06; scores.E *= 1.08; }

      return scores;
    }

    function renderResults(scores){
      const label = {A:'エチオピア',B:'コロンビア',C:'ブラジル',D:'ケニア',E:'インドネシア',F:'ブルンジ'};
      const arr = Object.entries(scores).map(([k,v])=>({code:k, name:label[k], score:Math.max(0, Math.round(v))})).sort((a,b)=> b.score - a.score);

      // ランキング
      document.getElementById('rank').innerHTML = arr.map((r,i)=> `<li><strong>${i+1}位</strong> ${r.code}. ${r.name}（${r.score}）</li>`).join('');

      // バー
      const max = arr[0].score || 1;
      document.getElementById('bars').innerHTML = arr.map(r=>(
        `<div class="bar-wrap"><div class="bar" style="width:${Math.round(100*r.score/max)}%"></div></div>`
      )).join('');

      // 共有用QR（ランキングをクエリに入れる）
      const q = encodeURIComponent(arr.map(r=>`${r.code}:${r.score}`).join(','));
      const shareUrl = location.origin + location.pathname + '?r=' + q;
      const wrap = document.getElementById('qrcode');
      wrap.innerHTML = '';
      new QRCode(wrap, { text: shareUrl, width: 132, height: 132 });

      // 表示
      document.getElementById('results').classList.remove('hidden');
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'instant' });
    }

    document.getElementById('submit').addEventListener('click', ()=>{
      let s = baseScores();
      s = applyAdjustments(s);
      renderResults(s);
      renderDynamicRefs(); // 論文表示
    });

    document.getElementById('back').addEventListener('click', ()=>{
      document.getElementById('results').classList.add('hidden');
      window.scrollTo({ top: 0, behavior: 'instant' });
    });

    document.getElementById('resetBtn').addEventListener('click', ()=>{
      for (let i=1;i<=16;i++){ document.getElementById('v_q'+i).textContent = '0'; }
      document.getElementById('results').classList.add('hidden');
      window.scrollTo({ top: 0, behavior: 'instant' });
    });

    /* ===== 論拠：回答寄与トップの設問に紐づく論文（動的表示） ===== */
    const REF_MAP = {
      // 嫌い嗜好（遺伝）
      q1: { title:'OR6A2 Variation Predicts Cilantro (Coriander) Aversion（Flavour, 2012, 2044-7248-1-22）',
            excerpt:'OR6A2 の多型がコリアンダーの“石鹸様”アルデヒド臭の知覚差と関連し、嫌悪の個人差を説明し得ると報告。' },
      q2: { title:'PROP Taste Sensitivity Is Associated with TAS2R38 Genotype（Scientific Reports, 2018, s41598-018-34713-z）',
            excerpt:'TAS2R38 多型と PROP 苦味感受性の関連が有意。PROP 高感受性者はキニーネ/カフェイン等の他の苦味にも敏感な傾向。' },
      q3: { title:'Positional Cloning of the Human QTL Underlying Taste Sensitivity to PTC（Science, 2003）',
            excerpt:'苦味受容体 TAS2R ファミリーの遺伝学的基盤を提示。苦味受容の個人差の根拠。' },
      // 性格・行動／発酵
      q14:{ title:'Spence, C. (2015). Multisensory flavor perception（Cell, 161(1)）',
            excerpt:'多感覚と味の関係の総説。刺激志向（例：ホラー嗜好）と味覚印象の結びつきを概説。' },
      q15:{ title:'Crossmodal correspondences and their relevance for flavour perception（Trends in Cognitive Sciences, 2020 など）',
            excerpt:'新奇性嗜好やクロスモーダル要因がフレーバー選好へ及ぼす影響のレビュー。' },
      q16:{ title:'Research Progress on Coffee Flavor Components（Food Science China, 2025）',
            excerpt:'発酵や焙煎プロセスが揮発性成分・官能評価に与える影響を総説。発酵好きの嗜好との関連を議論。' }
    };
    const WEIGHTS = { q1:1.2, q2:1.0, q3:0.8, q4:1.2, q5:1.2, q14:0.6, q15:0.7, q16:0.8 };

    function contribRank(){
      const ids = ['q1','q2','q3','q4','q5','q14','q15','q16'];
      const v = id => Number(document.getElementById(id).value)||0;
      return ids.map(id => ({ id, mag: v(id) * (WEIGHTS[id]||1) }))
                .sort((a,b)=> b.mag - a.mag)
                .filter(x => x.mag > 0);
    }

    function renderDynamicRefs(){
      const ul = document.getElementById('refList');
      if(!ul) return;
      const top = contribRank().filter(x => REF_MAP[x.id]).slice(0,3);
      ul.innerHTML = top.map(x => {
        const r = REF_MAP[x.id];
        return `<li style="margin:.45rem 0;"><em>${r.title}</em><br><span style="color:#666;">抜粋：${r.excerpt}</span></li>`;
      }).join('');
    }
  </script>
</body>
</html>
